---
import BaseLayout from '../../layouts/BaseLayout.astro'
import ShareButtons from '../../components/ShareButtons.astro'
import NewsletterCTA from '../../components/NewsletterCTA.astro'
import NewsletterFooter from '../../components/NewsletterFooter.astro'
import { getNewslettersWithAutoFeatured, formatDate } from '../../lib/newsletter-utils'

export const prerender = true

export async function getStaticPaths() {
  const newsletters = await getNewslettersWithAutoFeatured()
  return newsletters.map(newsletter => ({
    params: { slug: newsletter.slug },
    props: { newsletter },
  }))
}

const { newsletter } = Astro.props

// Add validation to prevent the error
if (!newsletter) {
  throw new Error('Newsletter not found')
}

const { Content } = await newsletter.render()
---

<BaseLayout
  title={`${newsletter.data.title} - Puro Suco Newsletter`}
  description={newsletter.data.description}
>
  <main class="container max-w-2xl mx-auto px-4 py-8 md:px-6 md:py-16">
    <!-- Header -->
    <header class="mb-8 md:mb-12">
      <div class="mb-6">
        <a
          href="/newsletters"
          class="text-amber-500 hover:text-amber-400 transition-colors text-sm font-medium"
        >
          ← Voltar ao arquivo
        </a>
      </div>

      <div class="flex items-center gap-2 sm:gap-4 mb-4 md:mb-6 flex-wrap">
        <span class="text-xs font-medium px-3 py-1 bg-gray-100 text-gray-600 rounded-full">
          Edição #{newsletter.data.issue}
        </span>
        {
          newsletter.data.featured && (
            <span class="text-xs font-medium px-3 py-1 bg-amber-100 text-amber-700 rounded-full">
              ⭐ Destaque
            </span>
          )
        }
        <time class="text-sm text-gray-500">
          {formatDate(newsletter.data.publishedAt)}
        </time>
      </div>

      <h1
        class="text-3xl sm:text-4xl md:text-5xl text-gray-900 font-serif leading-tight mb-3 md:mb-4"
      >
        {newsletter.data.title}
      </h1>

      <p class="text-base sm:text-lg md:text-xl text-gray-700 leading-relaxed mb-6 md:mb-8">
        {newsletter.data.description}
      </p>

      <ShareButtons
        title={newsletter.data.title}
        url={Astro.url.href}
        description={newsletter.data.description}
      />
    </header>

    <hr class="border-gray-200 mb-8 md:mb-12" />

    <!-- Content -->
    <article class="prose prose-gray prose-sm sm:prose md:prose-lg max-w-none mb-12 md:mb-16">
      <Content />
    </article>

    <!-- Newsletter CTA -->
    <NewsletterCTA showArchiveLink={true} />

    <!-- Footer -->
    <NewsletterFooter />
  </main>
</BaseLayout>
